S3 Integration

This project supports uploading rotated log archives to Amazon S3 via the Node AWS SDK v3.

Required environment variables

- S3_BUCKET: The target S3 bucket name (required to enable S3 path)
- AWS_REGION or AWS_DEFAULT_REGION: AWS region (default: us-east-1)
- AWS credentials: either set via environment variables or provided by an instance role
  - AWS_ACCESS_KEY_ID
  - AWS_SECRET_ACCESS_KEY
  - (optional) AWS_SESSION_TOKEN

Optional

- S3_PREFIX: prefix to prepend to uploaded keys
- REMOVE_AFTER_UPLOAD=1: remove local archive after a successful upload
- UPLOAD_RETRIES: number of upload attempts (default 3)
- UPLOAD_BACKOFF_MS: base backoff in ms (default 500)
- S3_ENDPOINT: custom S3-compatible endpoint (useful for MinIO/local testing)
- S3_FORCE_PATH_STYLE=1: use path-style addressing required by some local S3-compatible servers

Testing S3 access

1. Install SDKs (if not already installed):

   npm install @aws-sdk/client-s3 @aws-sdk/lib-storage

2. Quick check (read-only):

   export S3_BUCKET=my-bucket
   export AWS_REGION=us-east-1
   node scripts/check_s3.mjs

3. Full write test (will upload & delete a small object):

   export TEST_WRITE=1
   node scripts/check_s3.mjs

Local testing with MinIO (open-source S3-compatible server)

You can run MinIO locally to emulate S3. Example docker-compose (repos with docker available):

1. Create `docker-compose.minio.yml` with following content:

version: '3.7'
services:
  minio:
    image: minio/minio:RELEASE.2025-08-01T00-00-00Z
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    command: server /data --console-address ":9001"

2. Start MinIO:

   docker-compose -f docker-compose.minio.yml up -d

3. Create a bucket (use `mc` or the web console at http://localhost:9001):

   # Using mc (MinIO client) example:
   mc alias set local http://localhost:9000 minioadmin minioadmin
   mc mb local/my-test-bucket

4. Point the uploader at MinIO and force path-style addressing:

   export S3_BUCKET=my-test-bucket
   export AWS_REGION=us-east-1
   export AWS_ACCESS_KEY_ID=minioadmin
   export AWS_SECRET_ACCESS_KEY=minioadmin
   export S3_ENDPOINT=http://localhost:9000
   export S3_FORCE_PATH_STYLE=1
   export REMOVE_AFTER_UPLOAD=1
   node marketplace/server.js &
   node -e "import('./marketplace/logger.mjs').then(m=>m.rotateNow())"

Debugging

- If uploads fail with credential errors, ensure the AWS env vars are set in the process that runs `marketplace/server.js` (systemd unit, container env, or shell).
- Use `node scripts/check_s3.mjs` to get actionable error messages and hints.

Example: enable S3 and force a rotation

export S3_BUCKET=my-bucket
export AWS_REGION=us-east-1
export REMOVE_AFTER_UPLOAD=1
node marketplace/server.js &
node -e "import('./marketplace/logger.mjs').then(m=>m.rotateNow())"

